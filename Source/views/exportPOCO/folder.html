<script type="text/javascript">
    $(function () {
        function FolderViewModel() {
            var self = this;

            //Properties
            self.folder = ko.observable();
            self.tablesCount = ko.observable(0);
            self.tmplPreview = ko.observable();
            self.namespace = ko.observable("SomeNamespace.ModuleName");
            self.baseClass = ko.observable("BusinessBase");
            self.classTemplate = ko.observable();
            self.baseClassTemplate = ko.observable();
            self.exportBase = ko.observable(true);

            //Functions
            self.init = function () {
                self.LoadClassTemplate();

                self.tablesCount(App.Variables.SelectedTables.length);
                self.renderFirstTablePreview();
            }
            self.LoadClassTemplate = function()
            {
                $.ajaxSetup({ cache: false });

                //Load the class resources
                $.get("scripts/app/Resources/ClassTemplate.js", function (response) {
                    self.classTemplate(response);
                }).error(function (msg) { console.log(msg); });

                //Load the base class resources
                $.get("scripts/app/Resources/BaseClassTemplate.js", function (response) {
                    self.baseClassTemplate(response);
                }).error(function (msg) { console.log(msg); });
            }
            self.renderFirstTablePreview = function()
            {
                self.GetTableData(App.Variables.SelectedTables[0].tableName, function (data) {
                    self.tmplPreview($("#classTemplate").render(data));
                });
            }
            self.GetTableData = function(tableName, callback)
            {
                var objTeml = {
                    TableName: "",
                    Columns: [],
                    IdentityColumn: "",
                    IdentityType: "",
                    IdentityEnumType: "",
                    namespace: "",
                    baseClass: "",
                    exportBase: ""
                }
                var data = objTeml;
                data.TableName = tableName;
                data.namespace = self.namespace();
                data.baseClass = self.baseClass();
                data.exportBase = self.exportBase();

                //Get columns for first table
                App.ConnectSql(function (connection) {
                    var request = new App.sql.Request(connection);

                    request.query("exec sp_columns '" + data.TableName + "'", function (err, recordset) {
                        if (err != null && err.code != "") {
                            bootbox.alert(err.message, function () { });
                        }
                        else {
                            $(recordset).each(function (index, column) {
                                if (column.TYPE_NAME.toLowerCase().indexOf("identity") > 0)
                                {
                                    data.IdentityColumn = column.COLUMN_NAME;
                                    data.IdentityType = self.GetDataType(column.TYPE_NAME);
                                    data.IdentityEnumType = self.GetEnumDataType(column.TYPE_NAME);
                                }

                                var datType = self.GetDataType(column.TYPE_NAME);
                                data.Columns.push({
                                    ColumnName: column.COLUMN_NAME,
                                    DataType: datType,
                                    IsIntColumn: (datType == "int") ? true : false,
                                    EnumDataType: self.GetEnumDataType(column.TYPE_NAME)
                                });
                            });

                            callback(data);
                        }
                    });

                });

            }
            self.GetBaseData = function(callback)
            {
                var objTeml = {
                    namespace: "",
                    baseClass: ""
                }
                var data = objTeml;
                data.namespace = self.namespace();
                data.baseClass = self.baseClass();

                callback(data);
            }
            self.GetDataType = function(typeNam)
            {
                var value = "";

                switch(typeNam.toLowerCase())
                {
                    case "int identity": value = "int"; break;
                    case "int": value = "int"; break;
                    case "datetime": value = "DateTime"; break;
                    case "varchar": value = "string"; break;
                    case "text": value = "string"; break;
                    case "decimal": value = "Decimal"; break;
                    case "numeric": value = "Decimal"; break;
                    case "bigint": value = "Int64"; break;
                    case "bit": value = "bool"; break;
                    case "image": value = "byte[]"; break;
                    case "uniqueidentifier": value = "Guid"; break;
                }

                return value;
            }
            self.GetEnumDataType = function (typeNam) {
                var value = "";

                switch (typeNam.toLowerCase()) {
                    case "int identity": value = "SqlDbType.Int"; break;
                    case "int": value = "SqlDbType.Int"; break;
                    case "datetime": value = "SqlDbType.DateTime"; break;
                    case "varchar": value = "SqlDbType.VarChar"; break;
                    case "text": value = "SqlDbType.Text"; break;
                    case "decimal": value = "SqlDbType.Decimal"; break;
                    case "numeric": value = "SqlDbType.Money"; break;
                    case "bigint": value = "SqlDbType.BigInt"; break;
                    case "bit": value = "SqlDbType.Bit"; break;
                    case "image": value = "SqlDbType.Image"; break;
                    case "uniqueidentifier": value = "SqlDbType.UniqueIdentifier"; break;
                }

                return value;
            }
            self.writeTextFile = function(text, fileName)
            {
                App.fileSystem.writeFile(self.folder() + "\\" + fileName, text, function (err) {
                    
                });
            }

            //Events
            self.FormSubmit = function () {
                //Generate normal tables
                $(App.Variables.SelectedTables).each(function (index, table) {
                    self.GetTableData(table.tableName, function (data) {
                        var classText = $("#classTemplate").render(data);
                        self.writeTextFile(classText, table.tableName + ".cs");
                    });
                });
                //Generate base class
                if (self.exportBase()) {
                    self.GetBaseData(function (data) {
                        var classText = $("#baseClassTemplate").render(data);
                        self.writeTextFile(classText, self.baseClass() + ".cs");
                    });
                }
                bootbox.alert("Classes exported to " + self.folder() + "\\", function () { });
            }
            self.cancelClick = function (data, event) {
                App.PageManager.NavigateBack();
            }

            //Load View Model
            self.init();
        }

        App.Variables.activePageViewModel = new FolderViewModel();
        ko.applyBindings(App.Variables.activePageViewModel, document.getElementById("SelectFolder"));
    });
</script>

<div id="SelectFolder">
    <form data-bind="submit:FormSubmit">
        <div class="form-group">
            <label class="control-label">Selected Tables</label>
            <div>
                <span class="form-control-static" data-bind="text: tablesCount"></span>
            </div>
        </div>
        <div class="form-group">
            <label>Namespace</label>
            <input type="text" data-bind="value: namespace" class="form-control" required>
        </div>
        <div class="form-group">
            <label>Base Class</label>
            <input type="text" data-bind="value: baseClass" class="form-control" required>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" data-bind="checked: exportBase"> Export base class
            </label>
        </div>
        <div class="form-group">
            <label>Select a folder to export to</label>
            <input type="file" nwdirectory data-bind="value:folder" required />
            <p class="help-block">Export to: <span data-bind="text: folder"></span></p>
        </div>
        <button type="submit" class="btn btn-primary">Export Classes</button>
    </form>
    <br />
    <h3>Export Preview</h3>
    <textarea rows="25" class="form-control" data-bind="value:tmplPreview"></textarea>
    <script id="classTemplate" type="text/x-jquery-tmpl" data-bind="text: classTemplate"></script>
    <script id="baseClassTemplate" type="text/x-jquery-tmpl" data-bind="text: baseClassTemplate"></script>
</div>